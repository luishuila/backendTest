# ----- Lista blanca de orígenes (CORS) -----
# (Se evalúa dentro de 'http', por eso va fuera de 'server')
map $http_origin $cors_origin {
    default                                                       "";
    "http://localhost:4200"                                    $http_origin;
    "https://main.d22lhfa5x4lj9x.amplifyapp.com"               $http_origin;
    # Si quieres también localhost:3000, descomenta la siguiente línea:
    # "~^http://localhost:3000$"                                  $http_origin;
}

server {
  listen 80 default_server;
  server_name _;

  root /var/www/html/public;
  index index.php index.html;

  # ---------- CORS global ----------
  add_header 'Access-Control-Allow-Origin'      $cors_origin always;
  add_header 'Access-Control-Allow-Credentials' 'true'       always;
  add_header 'Access-Control-Allow-Methods'     'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
  add_header 'Access-Control-Allow-Headers'     'Authorization, Content-Type, X-Requested-With, X-XSRF-TOKEN' always;
  add_header 'Access-Control-Max-Age'           86400        always;
  add_header 'Vary'                              'Origin'    always;
  # ----------------------------------

  # Health check del ALB (sin tocar BD)
  location = /api/health {
    return 200 "OK";
    add_header Content-Type text/plain;
  }

  # Preflight y rutas de app
  location / {
    # Preflight: responde 204 (las cabeceras ya se añaden a nivel 'server')
    if ($request_method = OPTIONS) { return 204; }
    try_files $uri $uri/ /index.php?$query_string;
  }

  # Estáticos
  location ~* \.(?:jpg|jpeg|png|gif|svg|css|js|ico|woff2?|ttf|map)$ {
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
    try_files $uri =404;
  }

  # PHP-FPM
  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_index index.php;

    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_param PATH_INFO $fastcgi_path_info;

    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param DOCUMENT_ROOT  $document_root;
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;

    fastcgi_read_timeout 120;
    fastcgi_send_timeout 120;

    fastcgi_pass 127.0.0.1:9000;  # PHP-FPM local
  }

  # Seguridad
  location ~ /\.ht { deny all; }

  access_log /dev/stdout;
  error_log  /dev/stderr notice;
}
